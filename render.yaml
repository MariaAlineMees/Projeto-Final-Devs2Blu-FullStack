services:
  # 1. Banco de Dados PostgreSQL
  - type: pserv
    name: meu-roteiro-db
    plan: free
    postgres:
      version: "15"

  # 2. RabbitMQ
  - type: pserv
    name: rabbitmq
    plan: free
    image:
      url: rabbitmq:3-management-alpine

  # 3. Backend: Roteiro Service
  - type: web
    name: roteiro-service
    plan: free
    dockerfilePath: ./Back/roteiro-service/Dockerfile
    envVars:
      - key: SPRING_DATASOURCE_URL
        fromService:
          type: pserv
          name: meu-roteiro-db
          property: connectionString
      - key: SPRING_RABBITMQ_HOST
        fromService:
          type: pserv
          name: rabbitmq
          property: host

  # 4. Backend: Email Service
  - type: worker
    name: email-service
    plan: free
    dockerfilePath: ./Back/email-service/Dockerfile
    envVars:
      - key: SPRING_RABBITMQ_HOST
        fromService:
          type: pserv
          name: rabbitmq
          property: host

  # 5. Frontend: Roteiro Front (com Nginx)
  - type: web
    name: roteiro-front
    plan: free
    dockerfilePath: ./Front/Dockerfile
    # Adiciona uma regra de reescrita para a API
    routes:
      - type: rewrite
        source: /api/*
        destination: /api/*
      - type: rewrite
        source: /*
        destination: /index.html
    # Define a vari√°vel de ambiente para o Nginx se comunicar com o backend
    envVars:
      - key: NGINX_BACKEND_URL
        fromService:
          type: web
          name: roteiro-service
          property: url
